<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Quản lý đơn hàng</title>
  <link rel="stylesheet" href="/styles.css">
</head>
<body>
  <div class="container">
    <header>
      <h1>Đơn hàng</h1>
      <nav>
        <a href="/index.html">Trang chủ</a>
        <a href="/products.html">Sản phẩm</a>
        <a href="/customers.html">Khách hàng</a>
        <a href="/stats.html">Thống kê</a>
      </nav>
    </header>

    <div class="card">
      <form id="addOrderForm">
        <select id="customerSelect" name="customer_id" required>
          <option value="">-- Chọn khách hàng --</option>
        </select>

        <div style="width:100%"></div>

        <input id="productSearch" placeholder="Tìm sản phẩm theo tên..." autocomplete="off">
        <div id="searchResults"></div>
        <div id="productList" style="margin-top:8px"></div>

        <div style="width:100%"></div>

        <table id="itemsTable">
          <thead>
            <tr>
              <th>Sản phẩm</th>
              <th>Đơn giá</th>
              <th>Số lượng</th>
              <th>Thành tiền</th>
              <th></th>
            </tr>
          </thead>
          <tbody></tbody>
          <tfoot>
            <tr>
              <td colspan="3" style="text-align:right"><strong>Tổng:</strong></td>
              <td id="orderTotal">0</td>
              <td></td>
            </tr>
          </tfoot>
        </table>

        <button class="btn" type="submit">Tạo đơn</button>
      </form>

      <h3>Danh sách đơn hàng</h3>
      <div id="orderListContainer" style="max-height: 400px; overflow-y: auto; border: 1px solid #e8d7d7; border-radius: 4px; padding: 10px; scrollbar-width: thin; scrollbar-color: #dc3545 #f1f1f1;">
        <ul id="orderList" style="margin: 0; padding: 0; list-style: none;"></ul>
      </div>
      
      <style>
        #orderListContainer::-webkit-scrollbar {
          width: 6px;
        }
        #orderListContainer::-webkit-scrollbar-track {
          background: #f1f1f1;
          border-radius: 3px;
        }
        #orderListContainer::-webkit-scrollbar-thumb {
          background: #dc3545;
          border-radius: 3px;
        }
        #orderListContainer::-webkit-scrollbar-thumb:hover {
          background: #c82333;
        }
        
        #orderList li {
          padding: 12px 0;
          border-bottom: 1px solid #f0f0f0;
          transition: background-color 0.2s;
        }
        
        #orderList li:hover {
          background-color: #f8f9fa;
          border-radius: 4px;
          padding-left: 8px;
          padding-right: 8px;
        }
        
        #orderList li:last-child {
          border-bottom: none;
        }
      </style>
    </div>

    <script>
      async function loadCustomers() {
        const res = await fetch('/api/customers');
        if (!res.ok) return alert('Không lấy được danh sách khách hàng: ' + res.status);
        const data = await res.json();
        const sel = document.getElementById('customerSelect');
        sel.innerHTML = '<option value="">-- Chọn khách hàng --</option>';
        data.forEach(c => {
          const opt = document.createElement('option');
          opt.value = c.id;
          opt.textContent = `${c.id} — ${c.name} (${c.email})`;
          sel.appendChild(opt);
        });
      }

      async function loadOrders() {
        const res = await fetch('/api/orders');
        if (!res.ok) return alert('Lỗi khi tải đơn: ' + res.status);
        const data = await res.json();
        const ul = document.getElementById('orderList');
        ul.innerHTML = '';
        data.forEach(o => {
          const li = document.createElement('li');
          li.style.display = 'flex';
          li.style.justifyContent = 'space-between';
          li.style.alignItems = 'center';
          li.style.padding = '8px 0';
          li.style.borderBottom = '1px solid #e8d7d7';
          const left = document.createElement('span');
          left.textContent = `#${o.id} — Khách: ${o.customer_id} — Tổng: ${fmt(o.total)}`;
          const actions = document.createElement('div');
          const viewBtn = document.createElement('button');
          viewBtn.className = 'btn secondary';
          viewBtn.textContent = 'Xem';
          viewBtn.onclick = () => showOrderDetail(o.id);
          actions.appendChild(viewBtn);
          
          const pdfBtn = document.createElement('button');
          pdfBtn.className = 'btn';
          pdfBtn.style.backgroundColor = '#dc3545';
          pdfBtn.style.marginLeft = '8px';
          pdfBtn.textContent = 'Xuất PDF';
          pdfBtn.onclick = () => exportToPDF(o.id);
          actions.appendChild(pdfBtn);
          li.appendChild(left);
          li.appendChild(actions);
          ul.appendChild(li);
        });
      }

      async function showOrderDetail(orderId) {
        const res = await fetch('/api/orders/' + orderId);
        if (!res.ok) return alert('Không lấy được chi tiết đơn ' + orderId);
        const data = await res.json();
        const lines = [
          `Đơn #${data.id}`,
          `Khách hàng: ${data.customer_id}`,
          `Tổng: ${fmt(data.total)}`,
          '',
          'Sản phẩm:'
        ];
        data.items.forEach(it => {
          lines.push(`- ${it.name} x${it.quantity} — ${fmt(it.price)} = ${fmt(it.price * it.quantity)}`);
        });
        alert(lines.join('\n'));
      }

      async function exportToPDF(orderId) {
        try {
          const response = await fetch(`/api/orders/${orderId}/pdf`);
          if (!response.ok) {
            const error = await response.json();
            return alert('Lỗi khi xuất PDF: ' + (error.message || 'Không thể xuất PDF'));
          }
          
          // Tạo blob từ response
          const blob = await response.blob();
          
          // Tạo URL tạm thời và tải file
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `hoa-don-${orderId}.pdf`;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          window.URL.revokeObjectURL(url);
          
        } catch (error) {
          alert('Lỗi khi xuất PDF: ' + error.message);
        }
      }

      const state = { items: [] };

      const fmt = n => new Intl.NumberFormat('vi-VN').format(Number(n));

      function renderItems() {
        const tbody = document.querySelector('#itemsTable tbody');
        tbody.innerHTML = '';
        let total = 0;
        state.items.forEach((it, idx) => {
          const tr = document.createElement('tr');
          const subtotal = it.price * it.quantity;
          total += subtotal;
          tr.innerHTML = `
            <td>${it.name}</td>
            <td>${fmt(it.price)}</td>
            <td><input type="number" min="1" step="1" value="${it.quantity}" data-idx="${idx}" class="qty"></td>
            <td>${fmt(subtotal)}</td>
            <td><button type="button" class="btn secondary" data-remove="${idx}">Xóa</button></td>`;
          tbody.appendChild(tr);
        });
        document.getElementById('orderTotal').textContent = fmt(total);
      }

      function addItem(prod) {
        const exists = state.items.find(i => i.product_id === prod.id);
        if (exists) {
          exists.quantity += 1;
        } else {
          state.items.push({ product_id: prod.id, name: prod.name, price: Number(prod.price), quantity: 1 });
        }
        renderItems();
      }

      document.addEventListener('input', e => {
        if (e.target.classList.contains('qty')) {
          const idx = Number(e.target.getAttribute('data-idx'));
          let val = Number(e.target.value);
          if (!Number.isFinite(val) || val < 1) val = 1;
          state.items[idx].quantity = val;
          renderItems();
        }
      });

      document.addEventListener('click', e => {
        if (e.target.getAttribute('data-remove')) {
          e.preventDefault();
          const idx = Number(e.target.getAttribute('data-remove'));
          state.items.splice(idx, 1);
          renderItems();
        }
        if (e.target.getAttribute('data-add-prod')) {
          e.preventDefault();
          const prod = JSON.parse(e.target.getAttribute('data-add-prod'));
          addItem(prod);
        }
      });

      let searchTimer;
      document.getElementById('productSearch').addEventListener('input', e => {
        const q = e.target.value.trim();
        clearTimeout(searchTimer);
        if (!q) {
          document.getElementById('searchResults').innerHTML = '';
          // khi không tìm kiếm, hiện danh sách sản phẩm gợi ý
          renderProductList(window.__allProducts || []);
          return;
        }
        searchTimer = setTimeout(async () => {
          const res = await fetch('/api/products?q=' + encodeURIComponent(q));
          if (!res.ok) return;
          const data = await res.json();
          const box = document.getElementById('searchResults');
          box.innerHTML = '';
          data.slice(0, 8).forEach(p => {
            const div = document.createElement('div');
            div.style.display = 'flex';
            div.style.justifyContent = 'space-between';
            div.style.alignItems = 'center';
            div.style.padding = '6px 8px';
            div.style.border = '1px solid #e8d7d7';
            div.style.borderTop = 'none';
            div.innerHTML = `<span>${p.name} — ${fmt(p.price)}</span><button type="button" class="btn" data-add-prod='${JSON.stringify(p)}'>Thêm</button>`;
            box.appendChild(div);
          });
        }, 250);
      });

      function renderProductList(items) {
        const list = document.getElementById('productList');
        list.innerHTML = '';
        if (!items.length) return;
        const wrap = document.createElement('div');
        wrap.className = 'card';
        wrap.style.marginTop = '8px';
        
        const title = document.createElement('div');
        title.style.marginBottom = '6px';
        title.innerHTML = '<strong>Sản phẩm mới nhất</strong>';
        wrap.appendChild(title);
        
        // Tạo container có thể cuộn
        const scrollContainer = document.createElement('div');
        scrollContainer.style.maxHeight = '300px';
        scrollContainer.style.overflowY = 'auto';
        scrollContainer.style.border = '1px solid #e8d7d7';
        scrollContainer.style.borderRadius = '4px';
        
        // Tùy chỉnh thanh cuộn
        scrollContainer.style.scrollbarWidth = 'thin';
        scrollContainer.style.scrollbarColor = '#dc3545 #f1f1f1';
        
        // CSS cho webkit browsers (Chrome, Safari)
        const style = document.createElement('style');
        style.textContent = `
          .product-scroll::-webkit-scrollbar {
            width: 6px;
          }
          .product-scroll::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
          }
          .product-scroll::-webkit-scrollbar-thumb {
            background: #dc3545;
            border-radius: 3px;
          }
          .product-scroll::-webkit-scrollbar-thumb:hover {
            background: #c82333;
          }
        `;
        document.head.appendChild(style);
        scrollContainer.className = 'product-scroll';
        
        // Hiển thị tất cả sản phẩm (không giới hạn 8)
        items.forEach(p => {
          const row = document.createElement('div');
          row.style.display = 'flex';
          row.style.justifyContent = 'space-between';
          row.style.alignItems = 'center';
          row.style.padding = '8px 12px';
          row.style.borderBottom = '1px solid #f0f0f0';
          row.style.transition = 'background-color 0.2s';
          
          // Hiệu ứng hover
          row.addEventListener('mouseenter', () => {
            row.style.backgroundColor = '#f8f9fa';
          });
          row.addEventListener('mouseleave', () => {
            row.style.backgroundColor = 'transparent';
          });
          
          row.innerHTML = `
            <div style="flex: 1;">
              <div style="font-weight: 500; color: #333;">${p.name}</div>
              <div style="font-size: 12px; color: #666;">Giá: ${fmt(p.price)}</div>
            </div>
            <button type="button" class="btn" data-add-prod='${JSON.stringify(p)}' style="font-size: 12px; padding: 4px 8px;">Thêm</button>
          `;
          scrollContainer.appendChild(row);
        });
        
        wrap.appendChild(scrollContainer);
        list.appendChild(wrap);
      }

      document.getElementById('addOrderForm').onsubmit = async e => {
        e.preventDefault();
        const form = e.target;
        if (state.items.length === 0) {
          return alert('Hãy thêm ít nhất 1 sản phẩm vào hóa đơn');
        }
        const payload = {
          customer_id: Number(form.customer_id.value),
          items: state.items.map(it => ({ product_id: it.product_id, quantity: it.quantity }))
        };
        const r = await fetch('/api/orders', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        if (!r.ok) {
          let msg = r.statusText;
          try { const j = await r.json(); msg = j.error || JSON.stringify(j); } catch (_) {}
          return alert('Tạo đơn thất bại: ' + msg);
        }
        state.items = [];
        renderItems();
        form.reset();
        loadOrders();
      };

      // tải danh sách sản phẩm để hiển thị mặc định
      fetch('/api/products')
        .then(r => r.json())
        .then(arr => { window.__allProducts = arr; renderProductList(arr); })
        .catch(() => {});

      loadCustomers().then(loadOrders);
    </script>
  </div>
</body>
</html>